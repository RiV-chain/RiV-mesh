#script called from qinstall.sh

#SYS_QPKG_SERVICE_ENABLED="FALSE"
QPKG_NAME="mesh"
CONF=/etc/config/mesh.conf

PKG_PRE_REMOVE="{
  killall -q mesh
  rm -rf /share/Web/$QPKG_NAME
  [ -L /var/log/mesh.log ] && rm -f /var/log/mesh.log
}"

PKG_MAIN_REMOVE="{
  $CMD_RM -f $CONF
}"

pkg_pre_install(){
  killall -q mesh
  rm -rf /share/Web/$QPKG_NAME
  touch $CONF
  chmod a+w $CONF
}

pkg_install(){

  if [ -f $CONF ]; then
     mkdir -p /var/backups
     echo "Backing up configuration file to /var/backups/mesh.conf.`date +%Y%m%d`"
     cp $config_file /var/backups/mesh.conf.`date +%Y%m%d`
     echo "Normalising and updating $CONF"
     ${SYS_QPKG_DIR}/bin/mesh -useconf -normaliseconf < /var/backups/mesh.conf.`date +%Y%m%d` > $CONF
  else
     echo "Generating initial configuration file $config_file"
     echo "Please familiarise yourself with this file before starting RiV-mesh"
     sh -c "umask 0027 && ${SYS_QPKG_DIR}/bin/mesh -genconf > '$CONF'"
  fi

}
